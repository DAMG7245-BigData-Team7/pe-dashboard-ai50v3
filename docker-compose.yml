version: '3.8'

services:
  # ============================================================
  # MCP Server Service
  # ============================================================
  mcp-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.mcp
    container_name: orbit-mcp-server
    ports:
      - "9000:9000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-pe-dashboard-ai50}
      - MCP_PORT=9000
      - MCP_HOST=0.0.0.0
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - orbit-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # ============================================================
  # Agent/Workflow Service
  # ============================================================
  agent-workflow:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: orbit-agent-workflow
    depends_on:
      mcp-server:
        condition: service_healthy
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - MCP_BASE_URL=http://mcp-server:9000
      - HITL_AUTO_APPROVE=true
      - AGENT_MODEL=${AGENT_MODEL:-gpt-4o-mini}
      - AGENT_TEMPERATURE=${AGENT_TEMPERATURE:-0}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - orbit-network
    # Override command to run a specific workflow
    # command: ["python", "src/workflows/due_diligence_graph.py", "anthropic"]

# ============================================================
# Networks
# ============================================================
networks:
  orbit-network:
    driver: bridge

# ============================================================
# Volumes (optional: for persistence)
# ============================================================
volumes:
  orbit-data:
    driver: local
  orbit-logs:
    driver: local
